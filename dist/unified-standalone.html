<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Hostel Management Unified</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/dexie@3/dist/dexie.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#f1f5f9; font-family: system-ui, Arial, sans-serif; }
    @media print { .no-print { display:none !important; } body { background:white; } .shadow, .ring { box-shadow:none!important; } }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/javascript">
  const { useState, useEffect, useRef } = React;
  // Initialize Dexie using existing DB name
  const db = new Dexie('HostelManagementDB');
  db.version(1).stores({
    students: '++id, name',
    payments: '++id, studentId'
  });
  // We won't define later versions (Dexie will upgrade if already exists) - open existing stores names.

  function academicYear() {
    const y = new Date().getFullYear();
    return y + '-' + (y + 1);
  }

  function App() {
    const [tab, setTab] = useState('students');
    const [students, setStudents] = useState([]);
    const [payments, setPayments] = useState([]);
    const [loading, setLoading] = useState(true);
    const [logo, setLogo] = useState(localStorage.getItem('um_logo') || '');
    const [studentForm, setStudentForm] = useState({ name:'', mobile:'', faculty:'', wing:'', roomNo:'', studentType:'Hosteller', residencyStatus:'Permanent', annualFee:'', paymentMethod:'Cash' });
    const [paymentForm, setPaymentForm] = useState({ studentId:'', receiptNo:'', date: todayISO(), registrationFee:'', rentFee:'', waterFee:'', gymFee:'', otherFee:'', utrNo:'', paymentMethod:'Cash', paymentType:'Full Payment' });
    const [viewPayment, setViewPayment] = useState(null);

    function todayISO(){ return new Date().toISOString().substring(0,10); }

    const loadAll = async () => {
      setLoading(true);
      try {
        const s = await db.table('students').toArray();
        const p = await db.table('payments').orderBy('id').reverse().toArray();
        setStudents(s); setPayments(p);
      } finally { setLoading(false); }
    };

    useEffect(()=>{ loadAll(); },[]);

    const addStudent = async (e) => {
      e.preventDefault();
      if(!studentForm.name || !studentForm.mobile || !studentForm.faculty){ alert('Fill required fields'); return; }
      const newStudent = {
        name: studentForm.name,
        mobile: studentForm.mobile,
        email: '',
        enrollmentNo: '',
        faculty: studentForm.faculty,
        collegeName: studentForm.faculty,
        yearOfCollege: 'N/A',
        address: '',
        residencyStatus: studentForm.residencyStatus,
        wing: studentForm.wing || 'A',
        roomNo: studentForm.roomNo || 'NA',
        studentType: studentForm.studentType,
        joiningDate: new Date(),
        annualFee: parseFloat(studentForm.annualFee||'0'),
        createdAt: new Date(),
        updatedAt: new Date(),
        paymentMethod: studentForm.paymentMethod,
        status: 'Active'
      };
      await db.table('students').add(newStudent);
      setStudentForm({ name:'', mobile:'', faculty:'', wing:'', roomNo:'', studentType:'Hosteller', residencyStatus:'Permanent', annualFee:'', paymentMethod:'Cash' });
      loadAll();
    };

    const deleteStudent = async (id) => {
      if(!confirm('Delete student?')) return;
      await db.table('students').delete(id);
      loadAll();
    };

    const addPayment = async (e) => {
      e.preventDefault();
      if(!paymentForm.studentId || !paymentForm.receiptNo){ alert('Select student & receipt'); return; }
      const studentId = parseInt(paymentForm.studentId);
      const total = ['registrationFee','rentFee','waterFee','gymFee','otherFee']
        .map(f=> parseFloat(paymentForm[f]||'0')).reduce((a,b)=>a+b,0);
      const newPayment = {
        studentId,
        receiptNo: paymentForm.receiptNo,
        date: new Date(paymentForm.date),
        registrationFee: parseFloat(paymentForm.registrationFee||'0'),
        rentFee: parseFloat(paymentForm.rentFee||'0'),
        waterFee: parseFloat(paymentForm.waterFee||'0'),
        gymFee: parseFloat(paymentForm.gymFee||'0'),
        otherFee: parseFloat(paymentForm.otherFee||'0'),
        totalAmount: total,
        balanceAmount: 0,
        paymentStatus: 'Paid',
        utrNo: paymentForm.utrNo,
        paymentMethod: paymentForm.paymentMethod || 'Cash',
        cashier: 'System',
        createdAt: new Date()
      };
      await db.table('payments').add(newPayment);
      setPaymentForm({ studentId:'', receiptNo:'', date: todayISO(), registrationFee:'', rentFee:'', waterFee:'', gymFee:'', otherFee:'', utrNo:'', paymentMethod:'Cash', paymentType:'Full Payment' });
      loadAll();
      setTab('payments');
    };

    const deletePayment = async (id) => {
      if(!confirm('Delete payment?')) return; await db.table('payments').delete(id); loadAll(); };

    const numberToWords = (amount) => {
      if(amount===0) return 'Zero Only';
      const units=['','One','Two','Three','Four','Five','Six','Seven','Eight','Nine'];
      const teens=['Ten','Eleven','Twelve','Thirteen','Fourteen','Fifteen','Sixteen','Seventeen','Eighteen','Nineteen'];
      const tens=['','','Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];
      function chunk(num){ let r=''; if(num>=100){ r+=units[Math.floor(num/100)]+' Hundred '; num%=100; } if(num>=20){ r+=tens[Math.floor(num/10)]+' '; num%=10; } else if(num>=10){ r+=teens[num-10]+' '; return r; } if(num>0){ r+=units[num]+' '; } return r; }
      if(amount>=1e7){ const c=Math.floor(amount/1e7); const rem=amount%1e7; return chunk(c)+'Crore '+(rem?numberToWords(rem):'Only'); }
      if(amount>=1e5){ const l=Math.floor(amount/1e5); const rem=amount%1e5; return chunk(l)+'Lakh '+(rem?numberToWords(rem):'Only'); }
      if(amount>=1e3){ const th=Math.floor(amount/1e3); const rem=amount%1e3; return chunk(th)+'Thousand '+(rem?numberToWords(rem):'Only'); }
      return chunk(amount)+'Only';
    };

    const ReceiptView = ({ payment }) => {
      if(!payment) return <div className='p-4 text-sm text-gray-500'>Select a payment to view receipt.</div>;
      const student = students.find(s=>s.id===payment.studentId);
      const total = payment.totalAmount || 0;
      return (
        <div className='bg-white rounded-lg shadow p-6 receipt-container'>
          <div className='border-b-4 border-black pb-4 mb-4 flex items-center justify-between'>
            <div className='w-20 h-20 border-2 border-gray-700 rounded-full flex items-center justify-center overflow-hidden'>
              {logo ? <img src={logo} alt='Logo' className='w-full h-full object-cover'/> : <span className='text-xs font-bold'>LOGO</span>}
            </div>
            <div className='text-center flex-1 px-4'>
              <h1 className='text-2xl font-bold'>Dr. Rafiq Zakaria Campus</h1>
              <p className='text-sm text-gray-600'>Maulana Azad Educational Trust's</p>
              <h2 className='text-lg font-semibold'>Maulana Azad Complex of Hostel</h2>
              <p className='text-xs text-gray-600'>Aurangabad - 431 001 (M.S.)</p>
            </div>
            <div className='text-right text-xs'>Academic Year<br/><strong>{academicYear()}</strong></div>
          </div>
          <div className='flex justify-between mb-2 text-sm'>
            <div className='flex gap-2'><span className='font-semibold'>Receipt No:</span><span>{payment.receiptNo}</span></div>
            <div className='flex gap-2'><span className='font-semibold'>Date:</span><span>{new Date(payment.date).toLocaleDateString('en-IN')}</span></div>
          </div>
          <div className='bg-gray-800 text-white text-center py-2 mb-4 font-semibold'>NON-REFUNDABLE</div>
          <p className='text-sm mb-3'>Received the following Charges from</p>
          <div className='mb-4 text-sm'>
            <div className='flex gap-2 mb-2'><span className='font-semibold'>Shri.</span><span>{student?.name}</span></div>
            <div className='flex gap-4'>
              <div className='flex gap-2'><span className='font-semibold'>Faculty:</span><span>{student?.faculty}</span></div>
              <div className='flex gap-2'><span className='font-semibold'>Term:</span><span>{academicYear()}</span></div>
            </div>
          </div>
          <table className='w-full border border-gray-400 text-sm mb-4'>
            <thead>
              <tr className='bg-gray-100'>
                <th className='border border-gray-400 px-2 py-1 text-left'>Description</th>
                <th className='border border-gray-400 px-2 py-1 text-right w-32'>Amount</th>
              </tr>
            </thead>
            <tbody>
              <tr><td className='border px-2 py-1'>Registration Fee</td><td className='border px-2 py-1 text-right'>₹{payment.registrationFee||0}</td></tr>
              <tr><td className='border px-2 py-1'>Room Rent</td><td className='border px-2 py-1 text-right'>₹{payment.rentFee||0}</td></tr>
              <tr><td className='border px-2 py-1'>Water & Electricity</td><td className='border px-2 py-1 text-right'>₹{payment.waterFee||0}</td></tr>
              <tr><td className='border px-2 py-1'>GYM</td><td className='border px-2 py-1 text-right'>₹{payment.gymFee||0}</td></tr>
              <tr><td className='border px-2 py-1'>Others</td><td className='border px-2 py-1 text-right'>₹{payment.otherFee||0}</td></tr>
              <tr><td className='border px-2 py-1 font-semibold'>Online Payment (UTR)</td><td className='border px-2 py-1 text-right'>{payment.utrNo||'-'}</td></tr>
              <tr className='bg-gray-100 font-semibold'><td className='border px-2 py-1'>Total</td><td className='border px-2 py-1 text-right'>₹{total}</td></tr>
              <tr><td className='border px-2 py-1' colSpan='2'><span className='font-semibold'>Rs. (in words): </span>{numberToWords(total)}</td></tr>
            </tbody>
          </table>
          <div className='flex justify-between items-end border-t border-gray-400 pt-2 text-sm'>
            <p className='italic text-gray-600'>to be paid in first term only</p>
            <p className='font-semibold text-lg'>Cashier</p>
          </div>
        </div>
      );
    };

    const totalCalc = ['registrationFee','rentFee','waterFee','gymFee','otherFee']
      .map(f=> parseFloat(paymentForm[f]||'0')).reduce((a,b)=>a+b,0);

    const printCurrent = () => { window.print(); };
    const handleLogoUpload = (e) => { const file=e.target.files?.[0]; if(!file) return; const r=new FileReader(); r.onload=(ev)=>{ setLogo(ev.target.result); localStorage.setItem('um_logo', ev.target.result); }; r.readAsDataURL(file); };

    return (
      <div className='max-w-7xl mx-auto p-4'>
        <header className='bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-lg shadow p-6 mb-6'>
          <h1 className='text-3xl font-bold text-center'>Unified Hostel Management</h1>
          <p className='text-center text-sm mt-1'>Academic Year: {academicYear()}</p>
        </header>

        <nav className='no-print mb-6 bg-white rounded-lg shadow p-2 flex gap-2'>
          {['students','payments','receipt'].map(key => (
            <button key={key} onClick={()=>setTab(key)} className={'flex-1 py-3 rounded font-semibold transition '+(tab===key? 'bg-blue-600 text-white':'bg-gray-200 text-gray-700 hover:bg-gray-300')}>{key.charAt(0).toUpperCase()+key.slice(1)}</button>
          ))}
          <label className='flex-1 py-3 rounded font-semibold transition bg-purple-600 text-white text-center cursor-pointer'>Logo
            <input type='file' accept='image/*' onChange={handleLogoUpload} className='hidden' />
          </label>
        </nav>

        {tab==='students' && (
          <div>
            <div className='bg-white rounded-lg shadow p-6 mb-6'>
              <h2 className='text-xl font-bold mb-4'>Add Student</h2>
              <form onSubmit={addStudent} className='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4'>
                <input required placeholder='Name *' className='input' value={studentForm.name} onChange={e=>setStudentForm(f=>({...f,name:e.target.value}))} />
                <input required placeholder='Mobile *' className='input' value={studentForm.mobile} onChange={e=>setStudentForm(f=>({...f,mobile:e.target.value}))} />
                <input placeholder='Wing' className='input' value={studentForm.wing} onChange={e=>setStudentForm(f=>({...f,wing:e.target.value}))} />
                <input placeholder='Room No' className='input' value={studentForm.roomNo} onChange={e=>setStudentForm(f=>({...f,roomNo:e.target.value}))} />
                <input required placeholder='Faculty *' className='input' value={studentForm.faculty} onChange={e=>setStudentForm(f=>({...f,faculty:e.target.value}))} />
                <select className='input' value={studentForm.studentType} onChange={e=>setStudentForm(f=>({...f,studentType:e.target.value}))}>
                  <option>Hosteller</option><option>Non-Hosteller</option><option>PhD</option><option>Day Scholar</option>
                </select>
                <select required className='input' value={studentForm.residencyStatus} onChange={e=>setStudentForm(f=>({...f,residencyStatus:e.target.value}))}>
                  <option value='Permanent'>Permanent</option><option value='Temporary'>Temporary</option>
                </select>
                <input type='number' placeholder='Annual Fee' className='input' value={studentForm.annualFee} onChange={e=>setStudentForm(f=>({...f,annualFee:e.target.value}))} />
                <button type='submit' className='md:col-span-2 lg:col-span-3 bg-green-600 text-white py-3 rounded hover:bg-green-700 font-semibold'>Add Student</button>
              </form>
            </div>
            <div className='bg-white rounded-lg shadow p-6'>
              <h2 className='text-xl font-bold mb-4'>Students ({students.length})</h2>
              <div className='overflow-x-auto'>
                <table className='w-full text-sm'>
                  <thead className='bg-gray-50'>
                    <tr>
                      <th className='th'>Name</th><th className='th'>Type</th><th className='th'>Wing/Room</th><th className='th'>Faculty</th><th className='th'>Residency</th><th className='th'>Fee</th><th className='th'>Actions</th>
                    </tr>
                  </thead>
                  <tbody className='divide-y divide-gray-200'>
                    {students.map(s => (
                      <tr key={s.id}>
                        <td className='td'><div className='font-medium'>{s.name}</div><div className='text-xs text-gray-500'>{s.mobile}</div></td>
                        <td className='td'>{s.studentType}</td>
                        <td className='td'>{s.wing}-{s.roomNo}</td>
                        <td className='td'>{s.faculty}</td>
                        <td className='td'>{s.residencyStatus}</td>
                        <td className='td'>₹{s.annualFee||0}</td>
                        <td className='td'><button onClick={()=>deleteStudent(s.id)} className='text-red-600 hover:underline'>Delete</button></td>
                      </tr>
                    ))}
                    {students.length===0 && !loading && (<tr><td className='td text-center text-gray-500' colSpan='7'>No students</td></tr>)}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        )}

        {tab==='payments' && (
          <div>
            <div className='bg-white rounded-lg shadow p-6 mb-6'>
              <h2 className='text-xl font-bold mb-4'>Add Payment</h2>
              <form onSubmit={addPayment} className='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4'>
                <select required className='input' value={paymentForm.studentId} onChange={e=>setPaymentForm(f=>({...f,studentId:e.target.value}))}>
                  <option value=''>Select Student</option>
                  {students.map(s=> <option key={s.id} value={s.id}>{s.name} - {s.faculty}</option>)}
                </select>
                <input required placeholder='Receipt No *' className='input' value={paymentForm.receiptNo} onChange={e=>setPaymentForm(f=>({...f,receiptNo:e.target.value}))} />
                <input type='date' required className='input' value={paymentForm.date} onChange={e=>setPaymentForm(f=>({...f,date:e.target.value}))} />
                <select className='input' value={paymentForm.paymentType} onChange={e=>setPaymentForm(f=>({...f,paymentType:e.target.value}))}><option>Full Payment</option><option>Installment</option></select>
                <input type='number' placeholder='Registration Fee' className='input' value={paymentForm.registrationFee} onChange={e=>setPaymentForm(f=>({...f,registrationFee:e.target.value}))} />
                <input type='number' placeholder='Room Rent' className='input' value={paymentForm.rentFee} onChange={e=>setPaymentForm(f=>({...f,rentFee:e.target.value}))} />
                <input type='number' placeholder='Water & Electricity' className='input' value={paymentForm.waterFee} onChange={e=>setPaymentForm(f=>({...f,waterFee:e.target.value}))} />
                <input type='number' placeholder='Gym' className='input' value={paymentForm.gymFee} onChange={e=>setPaymentForm(f=>({...f,gymFee:e.target.value}))} />
                <input type='number' placeholder='Others' className='input' value={paymentForm.otherFee} onChange={e=>setPaymentForm(f=>({...f,otherFee:e.target.value}))} />
                <input placeholder='UTR Number' className='input' value={paymentForm.utrNo} onChange={e=>setPaymentForm(f=>({...f,utrNo:e.target.value}))} />
                <div className='md:col-span-2 lg:col-span-3 bg-blue-50 p-4 rounded flex justify-between items-center'>
                  <span className='font-semibold'>Total</span><span className='text-2xl font-bold text-blue-600'>₹{totalCalc}</span>
                </div>
                <button type='submit' className='md:col-span-2 lg:col-span-3 bg-green-600 text-white py-3 rounded hover:bg-green-700 font-semibold'>Record Payment</button>
              </form>
            </div>
            <div className='bg-white rounded-lg shadow p-6'>
              <h2 className='text-xl font-bold mb-4'>Payments ({payments.length})</h2>
              <div className='overflow-x-auto'>
                <table className='w-full text-sm'>
                  <thead className='bg-gray-50'>
                    <tr>
                      <th className='th'>Receipt</th><th className='th'>Student</th><th className='th'>Date</th><th className='th'>Amount</th><th className='th'>Actions</th>
                    </tr>
                  </thead>
                  <tbody className='divide-y divide-gray-200'>
                    {payments.map(p=>{ const stu=students.find(s=>s.id===p.studentId); return (
                      <tr key={p.id}>
                        <td className='td'>{p.receiptNo}</td>
                        <td className='td'><div className='font-medium'>{stu?.name||'Unknown'}</div><div className='text-xs text-gray-500'>{stu?.faculty}</div></td>
                        <td className='td'>{new Date(p.date).toLocaleDateString('en-IN')}</td>
                        <td className='td'>₹{p.totalAmount||0}</td>
                        <td className='td'><button className='text-blue-600 hover:underline mr-2' onClick={()=>{ setViewPayment(p); setTab('receipt'); }}>View</button><button className='text-red-600 hover:underline' onClick={()=>deletePayment(p.id)}>Delete</button></td>
                      </tr> ); })}
                    {payments.length===0 && !loading && (<tr><td className='td text-center text-gray-500' colSpan='5'>No payments</td></tr>)}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        )}

        {tab==='receipt' && (
          <div className='no-tailwind-print'>
            <div className='no-print mb-4 flex gap-2'>
              <button onClick={()=>setTab('payments')} className='bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded'>Back</button>
              <button onClick={printCurrent} className='bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center gap-2'><span>Print</span></button>
            </div>
            <ReceiptView payment={viewPayment} />
          </div>
        )}

        {loading && <div className='fixed inset-0 bg-black/20 flex items-center justify-center text-white text-lg'>Loading...</div>}
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
</script>
</body>
</html>